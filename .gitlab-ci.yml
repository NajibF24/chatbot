variables:
  # --- KONFIGURASI UMUM ---
  GIT_CLONE_PATH: '$CI_BUILDS_DIR/$CI_CONCURRENT_ID/project-portal-ai'
  GIT_CLEAN_FLAGS: -ffdx -e data/
  GIT_DEPTH: "0" # Penting untuk deteksi "New Code" di SonarQube

  # --- DOCKER IMAGES (Versioning dengan SHA Commit) ---
  SERVER_IMAGE: $CI_REGISTRY_IMAGE/server:$CI_COMMIT_SHORT_SHA
  SERVER_IMAGE_LATEST: $CI_REGISTRY_IMAGE/server:latest
  CLIENT_IMAGE: $CI_REGISTRY_IMAGE/client:$CI_COMMIT_SHORT_SHA
  CLIENT_IMAGE_LATEST: $CI_REGISTRY_IMAGE/client:latest

  # --- TARGET ---
  TARGET_URL: "https://portalai.gyssteel.com"
  
  # --- DEFECT DOJO URL (Internal IP) ---
  DD_URL: "http://172.16.21.82:8080"

stages:
  - code_quality  # SAST (SonarQube)
  - build         # Docker Build
  - security      # Container Scan (Trivy)
  - deploy        # Deploy ke Server
  - dast          # Web Attack Scan (ZAP)
  - report        # Upload ke DefectDojo

# ==========================================================
# 1. CODE QUALITY CHECK (SONARQUBE) - DIRECT API VERSION üöÄ
# ==========================================================
sonarqube_check:
  stage: code_quality
  tags:
    - portal-ai
  variables:
    GIT_DEPTH: "0"
  script:
    - echo "üß† Memulai Analisa Code Quality via Docker..."
    
    # 1. Ambil ID User Host
    - export HOST_UID=$(id -u)
    - export HOST_GID=$(id -g)
    
    # 2. Jalankan Docker
    - |
      docker run --rm \
      -e SONAR_HOST_URL="${SONAR_HOST_URL}" \
      -e SONAR_TOKEN="${SONAR_TOKEN}" \
      -v "$(pwd):/usr/src" \
      -w /usr/src \
      node:lts-bullseye \
      /bin/bash -c "
        # FUNGSI PEMBERSIH: Selalu jalan saat exit
        function cleanup {
            echo 'üßπ Fixing Permissions (Running cleanup)...'
            chown -R $HOST_UID:$HOST_GID .
        }
        trap cleanup EXIT

        echo 'üì¶ Installing Dependencies...' &&
        apt-get update > /dev/null && 
        apt-get install -y default-jre curl > /dev/null && 
        npm install -g sonarqube-scanner > /dev/null &&
        
        echo 'üîç Running Sonar Scanner...' &&
        # TAMBAHAN PENTING: -Dsonar.qualitygate.wait=true
        # Agar scanner menunggu server selesai memproses report sebelum lanjut
        sonar-scanner \
          -Dsonar.projectKey=portal-ai \
          -Dsonar.sources=. \
          -Dsonar.host.url=\$SONAR_HOST_URL \
          -Dsonar.login=\$SONAR_TOKEN \
          -Dsonar.qualitygate.wait=true \
          -Dsonar.exclusions='**/node_modules/**,**/dist/**,**/build/**,**/coverage/**' &&
          
        echo 'üìù Fetching Report from SonarQube API...' &&
        # KITA PAKAI CURL LANGSUNG KE API (Lebih Stabil)
        # Mengambil 500 issues pertama (bisa dinaikkan jika perlu)
        curl -s -u \"\$SONAR_TOKEN:\" \"\$SONAR_HOST_URL/api/issues/search?componentKeys=portal-ai&ps=500\" -o sonar-report.json
      "

  artifacts:
    paths:
      - sonar-report.json
    expire_in: 1 day
  allow_failure: true
  only:
    - main

# ==========================================================
# 2. BUILD & PUSH DOCKER IMAGES
# ==========================================================
build_push_images:
  stage: build
  tags:
    - portal-ai
  only:
    - main
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - echo "üèóÔ∏è Building & Pushing Images..."
    # Buat .env dari Variable GitLab
    - echo "$DOT_ENV_FILE" > .env
    
    # Build Server
    - docker build -t $SERVER_IMAGE -t $SERVER_IMAGE_LATEST ./server
    - docker push $SERVER_IMAGE
    - docker push $SERVER_IMAGE_LATEST
    
    # Build Client
    - docker build --build-arg REACT_APP_API_URL=${REACT_APP_API_URL} -t $CLIENT_IMAGE -t $CLIENT_IMAGE_LATEST ./client
    - docker push $CLIENT_IMAGE
    - docker push $CLIENT_IMAGE_LATEST

# ==========================================================
# 3. CONTAINER SECURITY SCAN (TRIVY)
# ==========================================================
container_security_scan:
  stage: security
  tags:
    - portal-ai
  needs: ["build_push_images"]
  allow_failure: true
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - echo "üõ°Ô∏è Memulai Container Security Scanning..."
    
    # 1. Scan Server Image
    - trivy image --scanners vuln,secret,misconfig --format json -o trivy-server.json $SERVER_IMAGE
    
    # 2. Scan Client Image
    - trivy image --scanners vuln,secret,misconfig --format json -o trivy-client.json $CLIENT_IMAGE

  artifacts:
    paths:
      - trivy-server.json
      - trivy-client.json
    expire_in: 1 day
  when: always

# ==========================================================
# 4. DEPLOY TO PRODUCTION
# ==========================================================
deploy_production:
  stage: deploy
  tags:
    - portal-ai
  only:
    - main
  needs: ["container_security_scan"] 
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY      
  script:
    - echo "üöÄ Memulai Deployment..."
    - echo "$DOT_ENV_FILE" > .env
    
    # Bersihkan container lama
    - docker rm -f mongo internal-chat-server internal-chat-client || true
    - docker compose down --remove-orphans || true
    
    # Pull image terbaru
    - docker pull $SERVER_IMAGE_LATEST
    - docker pull $CLIENT_IMAGE_LATEST
    
    # Start Services
    - docker compose up -d 
    - sleep 10
    - docker image prune -f

# ==========================================================
# 5. DAST SCAN (ZAP)
# ==========================================================
dast_scan:
  stage: dast
  tags:
    - portal-ai
  allow_failure: true
  needs: ["deploy_production"]
  script:
    - echo "üïµÔ∏è Memulai DAST Scanning (Passive Scan)..."
    - mkdir -p zap-reports
    - chmod 777 zap-reports
    - docker pull ghcr.io/zaproxy/zaproxy:stable
    
    # Menjalankan ZAP Baseline Scan
    - docker run --rm -v $(pwd)/zap-reports:/zap/wrk/:rw -t ghcr.io/zaproxy/zaproxy:stable zap-baseline.py -t $TARGET_URL -r zap-report.html -x zap-report.xml -I
    
  artifacts:
    paths:
      - zap-reports/zap-report.xml
    expire_in: 1 day
  when: always

# ==========================================================
# 6. UPLOAD REPORT TO DEFECTDOJO (ALL IN ONE)
# ==========================================================
upload_to_defectdojo:
  stage: report
  tags:
    - portal-ai
  image: curlimages/curl
  allow_failure: true
  # Job ini jalan setelah semua scan selesai
  needs: ["sonarqube_check", "container_security_scan", "dast_scan"]
  script:
    - echo "üìä Mengirim SEMUA Laporan ke DefectDojo..."
    
    # 1. Upload SonarQube (SAST)
    - |
      if [ -f "sonar-report.json" ]; then
        echo "Uploading SonarQube Report..."
        curl -X POST "$DD_URL/api/v2/import-scan/" \
        -H "Authorization: Token $DEFECT_DOJO_API_KEY" \
        -H "Content-Type: multipart/form-data" \
        -F "scan_type=SonarQube Scan" \
        -F "file=@sonar-report.json" \
        -F "product_name=Portal AI" \
        -F "engagement_name=GitLab CI Pipeline" \
        -F "auto_create_context=true" \
        -F "close_old_findings=true"
      else
        echo "‚ö†Ô∏è sonar-report.json tidak ditemukan."
      fi

    # 2. Upload Trivy SERVER (Container)
    - |
      if [ -f "trivy-server.json" ]; then
        echo "Uploading Trivy Server Report..."
        curl -X POST "$DD_URL/api/v2/import-scan/" \
        -H "Authorization: Token $DEFECT_DOJO_API_KEY" \
        -H "Content-Type: multipart/form-data" \
        -F "scan_type=Trivy Scan" \
        -F "file=@trivy-server.json" \
        -F "product_name=Portal AI" \
        -F "engagement_name=GitLab CI Pipeline" \
        -F "service=Backend Server" \
        -F "auto_create_context=true" \
        -F "close_old_findings=true"
      fi

    # 3. Upload Trivy CLIENT (Container)
    - |
      if [ -f "trivy-client.json" ]; then
        echo "Uploading Trivy Client Report..."
        curl -X POST "$DD_URL/api/v2/import-scan/" \
        -H "Authorization: Token $DEFECT_DOJO_API_KEY" \
        -H "Content-Type: multipart/form-data" \
        -F "scan_type=Trivy Scan" \
        -F "file=@trivy-client.json" \
        -F "product_name=Portal AI" \
        -F "engagement_name=GitLab CI Pipeline" \
        -F "service=Frontend Client" \
        -F "auto_create_context=true" \
        -F "close_old_findings=true"
      fi

    # 4. Upload ZAP (DAST)
    - |
      if [ -f "zap-reports/zap-report.xml" ]; then
        echo "Uploading ZAP DAST Report..."
        curl -X POST "$DD_URL/api/v2/import-scan/" \
        -H "Authorization: Token $DEFECT_DOJO_API_KEY" \
        -H "Content-Type: multipart/form-data" \
        -F "scan_type=ZAP Scan" \
        -F "file=@zap-reports/zap-report.xml" \
        -F "product_name=Portal AI" \
        -F "engagement_name=GitLab CI Pipeline" \
        -F "auto_create_context=true" \
        -F "close_old_findings=true"
      fi