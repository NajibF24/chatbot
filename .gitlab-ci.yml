variables:
  # Folder custom (Wajib karena kita pakai custom_build_dir)
  GIT_CLONE_PATH: '$CI_BUILDS_DIR/$CI_CONCURRENT_ID/project-baru-bersih'
  GIT_CLEAN_FLAGS: -ffdx -e data/
  
  # Definisi Nama Image di Registry GitLab Pusat
  # Ini akan menyimpan image ke git.gyssteel.com:5050/...
  SERVER_IMAGE: $CI_REGISTRY_IMAGE/server:latest
  CLIENT_IMAGE: $CI_REGISTRY_IMAGE/client:latest

stages:
  - security  # Trivy (Security Scan)
  - build     # Build & Push ke Registry
  - deploy    # Pull dari Registry & Run
  - dast

# --- JOB 1: SECURITY SCAN (TRIVY + HTML REPORT) ---
# Ini ringan, aman dijalankan di server 4GB
# --- JOB 1: SECURITY SCAN (TERPISAH SERVER & CLIENT) ---
security_scan:
  stage: security
  tags:
    - portal-ai
  allow_failure: true
  script:
    - echo "üõ°Ô∏è Memulai Security Scanning..."
    
    # 1. Download Template HTML
    - wget https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/html.tpl -O trivy-report.tpl
    
    # 2. SCAN SERVER (Simpan sebagai report-server.html)
    - echo "üîç Scanning Server..."
    - trivy fs --scanners vuln,secret,misconfig --format template --template "@trivy-report.tpl" -o report-server.html ./server
    
    # 3. SCAN CLIENT (Simpan sebagai report-client.html)
    - echo "üîç Scanning Client..."
    - trivy fs --scanners vuln,secret,misconfig --format template --template "@trivy-report.tpl" -o report-client.html ./client
    
    # 4. Tampilkan Ringkasan di Terminal (Opsional, biar log pipeline ada isinya)
    - trivy fs --scanners vuln,secret,misconfig ./server
    - trivy fs --scanners vuln,secret,misconfig ./client

  # Simpan KEDUA file laporan
  artifacts:
    name: "Security-Reports-$CI_COMMIT_SHORT_SHA"
    paths:
      - report-server.html
      - report-client.html
    expire_in: 7 days
    when: always
# --- JOB 2: BUILD & PUSH TO REGISTRY ---
# Image dibangun lalu dikirim ke GitLab Server (git.gyssteel.com)
# Jadi server on-premise ini tidak perlu menyimpan cache build yang besar
build_push_images:
  stage: build
  tags:
    - portal-ai
  only:
    - main
  before_script:
    # Login ke GitLab Registry otomatis menggunakan token CI/CD
    #- docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - echo "üèóÔ∏è Building & Pushing Images..."
    - echo "$DOT_ENV_FILE" > .env
    
    # Build & Push Server
    # Kita gunakan --cache-from agar build lebih cepat jika ada cache di registry
    - docker build -t $SERVER_IMAGE ./server
    - docker push $SERVER_IMAGE
    
    # Build & Push Client (dengan Build Args)
    - docker build --build-arg REACT_APP_API_URL=${REACT_APP_API_URL} -t $CLIENT_IMAGE ./client
    - docker push $CLIENT_IMAGE
    
    - echo "‚úÖ Images berhasil di-upload ke GitLab Registry."

# --- JOB 3: DEPLOY (PULL FROM REGISTRY) ---
# Di tahap ini, server hanya download image matang. Lebih stabil.
deploy_production:
  stage: deploy
  tags:
    - portal-ai
  only:
    - main
  needs: ["build_push_images"]
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY    
    #- docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "üöÄ Memulai Deployment..."
    - echo "$DOT_ENV_FILE" > .env
    
    # 1. Hapus container lama
    - docker rm -f mongo internal-chat-server internal-chat-client || true
    - docker compose down --remove-orphans || true
    
    # 2. Pull image terbaru dari Registry
    - docker pull $SERVER_IMAGE
    - docker pull $CLIENT_IMAGE
    
    # 3. Jalankan Aplikasi
    # (Pastikan docker-compose.yml sudah diedit menggunakan image: ${CI_REGISTRY_IMAGE}...)
    - docker compose up -d 
    
    # 4. Bersihkan image sampah (Penting untuk hemat disk server on-premise)
    - sleep 10
    - docker image prune -f
    - echo "‚úÖ Deployment Sukses!"
# --- JOB 4: DAST (OWASP ZAP - LIGHTWEIGHT) ---
dast_scan:
  stage: dast
  tags:
    - portal-ai
  image: 
    name: ghcr.io/zaproxy/zaproxy:stable
    entrypoint: [""]
  allow_failure: true # Jangan gagalkan pipeline kalau ada warning, cukup lapor saja
  variables:
    # URL website yang sudah running (Ganti dengan IP atau Domain Anda)
    TARGET_URL: "https://portalai.gyssteel.com" 
    # Catatan: Karena dijalankan dari dalam Container Docker, 
    # kita pakai IP Gateway Docker (172.17.0.1) untuk nembak ke Host/Server Asli.
    # Atau kalau punya domain publik (portal-ai.com), pakai domain itu lebih bagus.

  script:
    - echo "üïµÔ∏è Memulai DAST Scanning (ZAP Baseline)..."
    
    # Buat folder untuk report
    - mkdir -p zap-reports
    - chmod 777 zap-reports
    
    # Jalankan ZAP Baseline Scan
    # -t : Target URL
    # -r : Nama file report (HTML)
    # -I : Abaikan warning (biar job tetap hijau walau ada temuan minor)
    - zap-baseline.py -t $TARGET_URL -r zap-report.html -I
    
    - cp /zap/wrk/zap-report.html zap-reports/
    
  artifacts:
    name: "DAST-Report-$CI_COMMIT_SHORT_SHA"
    paths:
      - zap-reports/zap-report.html
    expire_in: 7 days
    when: always