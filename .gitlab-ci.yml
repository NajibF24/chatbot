stages:
  - build
  - deploy

build_images:
  stage: build
  tags:
    - portal-ai
  only:
    - main
  script:
    - echo "ðŸ—ï¸ Memulai Build..."
    - echo "$DOT_ENV_FILE" > .env
    - docker compose build
    - echo "âœ… Build Selesai."

deploy_production:
  stage: deploy
  tags:
    - portal-ai
  only:
    - main
  needs: ["build_images"]
    # --- BAGIAN INI SANGAT PENTING ---
  variables:
    # -ffdx : Clean force (hapus untracked files)
    # -e data/ : EXCLUDE (Jangan sentuh) folder data/
    GIT_CLEAN_FLAGS: -ffdx -e data/
  script:
    - echo "ðŸš€ Memulai Deployment..."
    - echo "$DOT_ENV_FILE" > .env
    
    # [PENTING] Gunakan path LENGKAP yang sama dengan docker-compose.yml
    - mkdir -p /home/admingys/internal-chat-picture/data/mongodb
    - mkdir -p /home/admingys/internal-chat-picture/server/data
    
    # Berikan izin agar Runner bisa menulis ke folder milik User Admingys
    - chmod -R 777 /home/admingys/internal-chat-picture/data
    - chmod -R 777 /home/admingys/internal-chat-picture/server/data

    # Hapus container lama (supaya tidak conflict)
    - docker rm -f mongo internal-chat-server internal-chat-client || true
    - docker compose down --remove-orphans || true

    # Jalankan
    - docker compose up -d 

    # Bersihkan
    - sleep 10
    - docker image prune -f
    - echo "âœ… Deployment Sukses!"
