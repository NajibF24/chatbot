# --- KONFIGURASI FOLDER BARU ---
variables:
  # Ini akan memaksa runner bekerja di folder baru
  # Folder lama yang error akan ditinggalkan
  GIT_CLONE_PATH: '$CI_BUILDS_DIR/$CI_CONCURRENT_ID/project-baru-bersih'
  GIT_CLEAN_FLAGS: -ffdx -e data/

stages:
  - build
  - deploy

# --- JOB 1: BUILD IMAGE ---
build_images:
  stage: build
  tags:
    - portal-ai
  only:
    - main
  script:
    - echo "ðŸ—ï¸ Memulai Build di folder baru..."
    - echo "$DOT_ENV_FILE" > .env
    - docker compose build
    - echo "âœ… Build Selesai."

# --- JOB 2: DEPLOY PRODUCTION ---
deploy_production:
  stage: deploy
  tags:
    - portal-ai
  only:
    - main
  needs: ["build_images"]
  
  script:
    - echo "ðŸš€ Memulai Deployment..."
    
    # 1. Restore .env
    - echo "$DOT_ENV_FILE" > .env
    
    # 2. Hapus container lama
    - docker rm -f mongo internal-chat-server internal-chat-client || true
    - docker compose down --remove-orphans || true
    
    # 3. Jalankan Aplikasi
    # (Menggunakan data di folder /home/admingys/... yang sudah kita fix sebelumnya)
    - docker compose up -d 
    
    # 4. Cek Kesehatan
    - sleep 10
    - docker compose ps
    - docker image prune -f
    - echo "âœ… Deployment Sukses!"
